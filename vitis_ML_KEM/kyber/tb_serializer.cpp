#include <iostream>
#include <iomanip>
#include <cstring> // Cho memset
#include "params.h"

// Khai báo hàm Top-level Wrapper
void serializer_top(
    int16 coeffs_in[256], uint8 msg_in[32], uint8 pk_in[384],
    uint8 u_out[320], uint8 v_out[128], int16 coeffs_out[256],
    int mode // 0: decode_pk, 1: from_msg, 2: compress_u, 3: compress_v
);

// --- HÀM HỖ TRỢ KIỂM TRA ---

// So sánh mảng int16 (có hỗ trợ Modulo cho trường hợp decode PK)
bool verify_int16(int16* hw, int16* exp, int len, std::string name) {
    bool pass = true;
    std::cout << "Checking " << name << "... ";
    for(int i=0; i<len; i++) {
        // Fix lỗi 3340 vs 11: So sánh phần dư Modulo Q
        // Vì HW giải nén thô (Raw), còn Python giải nén có Modulo.
        int16 hw_mod = hw[i] % KYBER_Q; 
        if (hw_mod < 0) hw_mod += KYBER_Q; // Đề phòng số âm (dù ở đây là unsigned)

        if(hw_mod != exp[i]) {
            std::cout << "\n[FAIL] idx " << i 
                      << " HW=" << hw[i] << " (Mod=" << hw_mod << ")"
                      << " Exp=" << exp[i] << std::endl;
            pass = false;
            if(i>5) break; 
        }
    }
    if(pass) std::cout << "[PASS]" << std::endl;
    return pass;
}

// So sánh mảng uint8 (cho Compress)
bool verify_uint8(uint8* hw, uint8* exp, int len, std::string name) {
    bool pass = true;
    std::cout << "Checking " << name << "... ";
    for(int i=0; i<len; i++) {
        if(hw[i] != exp[i]) {
            std::cout << "\n[FAIL] idx " << i << " HW=" << (int)hw[i] << " Exp=" << (int)exp[i] << std::endl;
            pass = false;
            if(i>5) break;
        }
    }
    if(pass) std::cout << "[PASS]" << std::endl;
    return pass;
}

int main() {
    std::cout << "--- TEST SERIALIZER & COMPRESS ---" << std::endl;
    
    // Khai báo các buffer dùng chung
    int16 coeffs_in[256] = {0};
    uint8 msg_in[32] = {0};
    uint8 pk_in[384] = {0};
    
    uint8 u_out[320];
    uint8 v_out[128];
    int16 coeffs_out[256];
    
    bool all_pass = true;

    // =================================================================
    // 1. TEST POLY_FROMBYTES (Decode PK 12-bit)
    // =================================================================
    {
        // --- COPY DATA TỪ PYTHON VÀO ĐÂY (input_pk_bytes, expected_pk_coeffs) ---
        uint8 input_pk_bytes[384] = {
            0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
            16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,
            32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47,
            48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63,
            64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79,
            80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95,
            96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111,
            112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127,
            128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143,
            144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159,
            160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175,
            176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191,
            192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207,
            208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223,
            224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239,
            240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255,
            0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
            16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,
            32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47,
            48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63,
            64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79,
            80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95,
            96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111,
            112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127
        };      // <--- Paste Input PK
        int16 expected_pk_coeffs[256] = {
            256, 32, 1027, 80, 1798, 128, 2569, 176, 11, 224, 15, 273, 786, 321, 1557, 369,
            2328, 417, 3099, 465, 541, 513, 545, 562, 1316, 610, 2087, 658, 2858, 706, 300, 754,
            304, 803, 1075, 851, 1846, 899, 2617, 947, 59, 995, 63, 1044, 834, 1092, 1605, 1140,
            2376, 1188, 3147, 1236, 589, 1284, 593, 1333, 1364, 1381, 2135, 1429, 2906, 1477, 348, 1525,
            352, 1574, 1123, 1622, 1894, 1670, 2665, 1718, 107, 1766, 111, 1815, 882, 1863, 1653, 1911,
            2424, 1959, 3195, 2007, 637, 2055, 641, 2104, 1412, 2152, 2183, 2200, 2954, 2248, 396, 2296,
            400, 2345, 1171, 2393, 1942, 2441, 2713, 2489, 155, 2537, 159, 2586, 930, 2634, 1701, 2682,
            2472, 2730, 3243, 2778, 685, 2826, 689, 2875, 1460, 2923, 2231, 2971, 3002, 3019, 444, 3067,
            448, 3116, 1219, 3164, 1990, 3212, 2761, 3260, 203, 3308, 207, 28, 978, 76, 1749, 124,
            2520, 172, 3291, 220, 733, 268, 737, 317, 1508, 365, 2279, 413, 3050, 461, 492, 509,
            496, 558, 1267, 606, 2038, 654, 2809, 702, 251, 750, 255, 16, 770, 64, 1541, 112,
            2312, 160, 3083, 208, 525, 256, 529, 305, 1300, 353, 2071, 401, 2842, 449, 284, 497,
            288, 546, 1059, 594, 1830, 642, 2601, 690, 43, 738, 47, 787, 818, 835, 1589, 883,
            2360, 931, 3131, 979, 573, 1027, 577, 1076, 1348, 1124, 2119, 1172, 2890, 1220, 332, 1268,
            336, 1317, 1107, 1365, 1878, 1413, 2649, 1461, 91, 1509, 95, 1558, 866, 1606, 1637, 1654,
            2408, 1702, 3179, 1750, 621, 1798, 625, 1847, 1396, 1895, 2167, 1943, 2938, 1991, 380, 2039
        };  // <--- Paste Expected Coeffs
        // ------------------------------------------------------------------------

        // Copy vào buffer
        for(int i=0; i<384; i++) pk_in[i] = input_pk_bytes[i];
        
        // Mode 0: Decode PK
        serializer_top(coeffs_in, msg_in, pk_in, u_out, v_out, coeffs_out, 0);
        
        if(!verify_int16(coeffs_out, expected_pk_coeffs, 256, "1. PolyFromBytes")) 
            all_pass = false;
    }

    // =================================================================
    // 2. TEST POLY_FROMMSG (Decode Msg 1-bit)
    // =================================================================
    {
        // --- COPY DATA TỪ PYTHON VÀO ĐÂY (input_msg, expected_msg_coeffs) ---
        uint8 input_msg[32] = {
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170,
            170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170
        };             // <--- Paste Input Msg
        int16 expected_msg_coeffs[256] = {
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665,
            0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665, 0, 1665
        };  // <--- Paste Expected Coeffs
        // --------------------------------------------------------------------

        // Copy vào buffer
        for(int i=0; i<32; i++) msg_in[i] = input_msg[i];
        
        // Mode 1: From Msg
        serializer_top(coeffs_in, msg_in, pk_in, u_out, v_out, coeffs_out, 1);
        
        if(!verify_int16(coeffs_out, expected_msg_coeffs, 256, "2. PolyFromMsg")) 
            all_pass = false;
    }

    // =================================================================
    // 3. TEST COMPRESS U (d=10)
    // =================================================================
    {
        // --- COPY DATA TỪ PYTHON VÀO ĐÂY (input_u_coeffs, expected_packed_u) ---
        int16 input_u_coeffs[256] = {
            0, 13, 26, 39, 52, 65, 78, 91, 104, 117, 130, 143, 156, 169, 182, 195,
            208, 221, 234, 247, 260, 273, 286, 299, 312, 325, 338, 351, 364, 377, 390, 403,
            416, 429, 442, 455, 468, 481, 494, 507, 520, 533, 546, 559, 572, 585, 598, 611,
            624, 637, 650, 663, 676, 689, 702, 715, 728, 741, 754, 767, 780, 793, 806, 819,
            832, 845, 858, 871, 884, 897, 910, 923, 936, 949, 962, 975, 988, 1001, 1014, 1027,
            1040, 1053, 1066, 1079, 1092, 1105, 1118, 1131, 1144, 1157, 1170, 1183, 1196, 1209, 1222, 1235,
            1248, 1261, 1274, 1287, 1300, 1313, 1326, 1339, 1352, 1365, 1378, 1391, 1404, 1417, 1430, 1443,
            1456, 1469, 1482, 1495, 1508, 1521, 1534, 1547, 1560, 1573, 1586, 1599, 1612, 1625, 1638, 1651,
            1664, 1677, 1690, 1703, 1716, 1729, 1742, 1755, 1768, 1781, 1794, 1807, 1820, 1833, 1846, 1859,
            1872, 1885, 1898, 1911, 1924, 1937, 1950, 1963, 1976, 1989, 2002, 2015, 2028, 2041, 2054, 2067,
            2080, 2093, 2106, 2119, 2132, 2145, 2158, 2171, 2184, 2197, 2210, 2223, 2236, 2249, 2262, 2275,
            2288, 2301, 2314, 2327, 2340, 2353, 2366, 2379, 2392, 2405, 2418, 2431, 2444, 2457, 2470, 2483,
            2496, 2509, 2522, 2535, 2548, 2561, 2574, 2587, 2600, 2613, 2626, 2639, 2652, 2665, 2678, 2691,
            2704, 2717, 2730, 2743, 2756, 2769, 2782, 2795, 2808, 2821, 2834, 2847, 2860, 2873, 2886, 2899,
            2912, 2925, 2938, 2951, 2964, 2977, 2990, 3003, 3016, 3029, 3042, 3055, 3068, 3081, 3094, 3107,
            3120, 3133, 3146, 3159, 3172, 3185, 3198, 3211, 3224, 3237, 3250, 3263, 3276, 3289, 3302, 3315
        };      // <--- Paste Input Coeffs
        uint8 expected_packed_u[320] = {
            0, 16, 128, 0, 3, 16, 80, 128, 1, 7, 32, 144, 128, 2, 11, 48,
            208, 128, 3, 15, 64, 16, 129, 4, 19, 80, 80, 129, 5, 23, 96, 144,
            129, 6, 27, 112, 208, 129, 7, 31, 128, 16, 130, 8, 35, 144, 80, 130,
            9, 39, 160, 144, 130, 10, 43, 176, 208, 130, 11, 47, 192, 16, 131, 12,
            51, 208, 80, 131, 13, 55, 224, 144, 131, 14, 59, 240, 208, 131, 15, 63,
            0, 17, 132, 16, 67, 16, 81, 132, 17, 71, 32, 145, 132, 18, 75, 48,
            209, 132, 19, 79, 64, 17, 133, 20, 83, 80, 81, 133, 21, 87, 96, 145,
            133, 22, 91, 112, 209, 133, 23, 95, 128, 17, 134, 24, 99, 144, 81, 134,
            25, 103, 160, 145, 134, 26, 107, 176, 209, 134, 27, 111, 192, 17, 135, 28,
            115, 208, 81, 135, 29, 119, 224, 145, 135, 30, 123, 240, 209, 135, 31, 127,
            0, 18, 136, 32, 131, 16, 82, 136, 33, 135, 32, 146, 136, 34, 139, 48,
            210, 136, 35, 143, 64, 18, 137, 36, 147, 80, 82, 137, 37, 151, 96, 146,
            137, 38, 155, 112, 210, 137, 39, 159, 128, 18, 138, 40, 163, 144, 82, 138,
            41, 167, 160, 146, 138, 42, 171, 176, 210, 138, 43, 175, 192, 18, 139, 44,
            179, 208, 82, 139, 45, 183, 224, 146, 139, 46, 187, 240, 210, 139, 47, 191,
            0, 19, 140, 48, 195, 16, 83, 140, 49, 199, 32, 147, 140, 50, 203, 48,
            211, 140, 51, 207, 64, 19, 141, 52, 211, 80, 83, 141, 53, 215, 96, 147,
            141, 54, 219, 112, 211, 141, 55, 223, 128, 19, 142, 56, 227, 144, 83, 142,
            57, 231, 160, 147, 142, 58, 235, 176, 211, 142, 59, 239, 192, 19, 143, 60,
            243, 208, 83, 143, 61, 247, 224, 147, 143, 62, 251, 240, 211, 143, 63, 255
        };   // <--- Paste Expected Bytes
        // -----------------------------------------------------------------------

        // Copy vào buffer
        for(int i=0; i<256; i++) coeffs_in[i] = input_u_coeffs[i];
        
        // Mode 2: Compress U
        serializer_top(coeffs_in, msg_in, pk_in, u_out, v_out, coeffs_out, 2);
        
        if(!verify_uint8(u_out, expected_packed_u, 320, "3. Compress U (d=10)")) 
            all_pass = false;
    }

    // =================================================================
    // 4. TEST COMPRESS V (d=4)
    // =================================================================
    {
        // --- COPY DATA TỪ PYTHON VÀO ĐÂY (input_v_coeffs, expected_packed_v) ---
        int16 input_v_coeffs[256] = {
            0, 7, 14, 21, 28, 35, 42, 49, 56, 63, 70, 77, 84, 91, 98, 105,
            112, 119, 126, 133, 140, 147, 154, 161, 168, 175, 182, 189, 196, 203, 210, 217,
            224, 231, 238, 245, 252, 259, 266, 273, 280, 287, 294, 301, 308, 315, 322, 329,
            336, 343, 350, 357, 364, 371, 378, 385, 392, 399, 406, 413, 420, 427, 434, 441,
            448, 455, 462, 469, 476, 483, 490, 497, 504, 511, 518, 525, 532, 539, 546, 553,
            560, 567, 574, 581, 588, 595, 602, 609, 616, 623, 630, 637, 644, 651, 658, 665,
            672, 679, 686, 693, 700, 707, 714, 721, 728, 735, 742, 749, 756, 763, 770, 777,
            784, 791, 798, 805, 812, 819, 826, 833, 840, 847, 854, 861, 868, 875, 882, 889,
            896, 903, 910, 917, 924, 931, 938, 945, 952, 959, 966, 973, 980, 987, 994, 1001,
            1008, 1015, 1022, 1029, 1036, 1043, 1050, 1057, 1064, 1071, 1078, 1085, 1092, 1099, 1106, 1113,
            1120, 1127, 1134, 1141, 1148, 1155, 1162, 1169, 1176, 1183, 1190, 1197, 1204, 1211, 1218, 1225,
            1232, 1239, 1246, 1253, 1260, 1267, 1274, 1281, 1288, 1295, 1302, 1309, 1316, 1323, 1330, 1337,
            1344, 1351, 1358, 1365, 1372, 1379, 1386, 1393, 1400, 1407, 1414, 1421, 1428, 1435, 1442, 1449,
            1456, 1463, 1470, 1477, 1484, 1491, 1498, 1505, 1512, 1519, 1526, 1533, 1540, 1547, 1554, 1561,
            1568, 1575, 1582, 1589, 1596, 1603, 1610, 1617, 1624, 1631, 1638, 1645, 1652, 1659, 1666, 1673,
            1680, 1687, 1694, 1701, 1708, 1715, 1722, 1729, 1736, 1743, 1750, 1757, 1764, 1771, 1778, 1785
        };      // <--- Paste Input Coeffs
        uint8 expected_packed_v[128] = {
            0, 0, 0, 0, 0, 0, 0, 16, 17, 17, 17, 17, 17, 17, 17, 17,
            17, 17, 17, 17, 17, 17, 33, 34, 34, 34, 34, 34, 34, 34, 34, 34,
            34, 34, 34, 34, 34, 50, 51, 51, 51, 51, 51, 51, 51, 51, 51, 51,
            51, 51, 51, 51, 67, 68, 68, 68, 68, 68, 68, 68, 68, 68, 68, 68,
            68, 68, 68, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85, 85,
            85, 85, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102, 102,
            102, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 119, 135,
            136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 152, 153
        };   // <--- Paste Expected Bytes
        // -----------------------------------------------------------------------

        // Copy vào buffer
        for(int i=0; i<256; i++) coeffs_in[i] = input_v_coeffs[i];
        
        // Mode 3: Compress V
        serializer_top(coeffs_in, msg_in, pk_in, u_out, v_out, coeffs_out, 3);
        
        if(!verify_uint8(v_out, expected_packed_v, 128, "4. Compress V (d=4)")) 
            all_pass = false;
    }

    std::cout << "=============================================" << std::endl;
    if(all_pass) {
        std::cout << "   SERIALIZER MODULE PASSED!" << std::endl;
        return 0;
    } else {
        std::cout << "   SERIALIZER MODULE FAILED." << std::endl;
        return 1;
    }
}