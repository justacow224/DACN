#include <iostream>
#include <iomanip>
#include "params.h"

// Khai báo hàm Top
void cbd_top(ap_uint<64> input_buf[16], int16 coeffs[256]);

// Hàm verify
bool verify(int16* hw, int16* exp, std::string name) {
    bool pass = true;
    std::cout << "Checking " << name << "... ";
    for(int i=0; i<256; i++) {
        if(hw[i] != exp[i]) {
            std::cout << "\n[FAIL] Index " << i << " HW=" << hw[i] << " Exp=" << exp[i] << std::endl;
            pass = false;
            if(i>5) break; // In ít lỗi thôi
        }
    }
    if(pass) std::cout << "[PASS]" << std::endl;
    return pass;
}

int main() {
    std::cout << "=============================================" << std::endl;
    std::cout << "          TESTING CBD (ETA=2)" << std::endl;
    std::cout << "=============================================" << std::endl;
    
    int16 hw_out[256];
    bool all_pass = true;

    // ======================================================
    // CASE 1: INPUT TOÀN SỐ 0
    // Kỳ vọng: Output toàn số 0
    // ======================================================
    ap_uint<64> input_case1[16] = {
        0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
        0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
        0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000,
        0x0000000000000000, 0x0000000000000000, 0x0000000000000000, 0x0000000000000000
    }; 
    int16 expected_case1[256] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };   
    
    // (Nếu bạn lười chạy Python: Input 0 -> CBD ra 0 là chắc chắn)
    
    cbd_top(input_case1, hw_out);
    if(!verify(hw_out, expected_case1, "Case 1: Zero Input")) all_pass = false;


    // ======================================================
    // CASE 2: INPUT NGẪU NHIÊN (PATTERN)
    // ======================================================
    // [DÁN OUTPUT TỪ PYTHON SCRIPT VÀO ĐÂY]
    ap_uint<64> input_case2[16] = {
        0x0706050403020100, 0x0f0e0d0c0b0a0908, 0x1716151413121110, 0x1f1e1d1c1b1a1918,
        0x2726252423222120, 0x2f2e2d2c2b2a2928, 0x3736353433323130, 0x3f3e3d3c3b3a3938,
        0x4746454443424140, 0x4f4e4d4c4b4a4948, 0x5756555453525150, 0x5f5e5d5c5b5a5958,
        0x6766656463626160, 0x6f6e6d6c6b6a6968, 0x7776757473727170, 0x7f7e7d7c7b7a7978
    }; // <--- Paste mảng Input vào đây
    int16 expected_case2[256] = {
        0, 0, 1, 0, 1, 0, 2, 0, 3328, 0, 0, 0, 0, 0, 1, 0,
        3328, 0, 0, 0, 0, 0, 1, 0, 3327, 0, 3328, 0, 3328, 0, 0, 0,
        0, 1, 1, 1, 1, 1, 2, 1, 3328, 1, 0, 1, 0, 1, 1, 1,
        3328, 1, 0, 1, 0, 1, 1, 1, 3327, 1, 3328, 1, 3328, 1, 0, 1,
        0, 1, 1, 1, 1, 1, 2, 1, 3328, 1, 0, 1, 0, 1, 1, 1,
        3328, 1, 0, 1, 0, 1, 1, 1, 3327, 1, 3328, 1, 3328, 1, 0, 1,
        0, 2, 1, 2, 1, 2, 2, 2, 3328, 2, 0, 2, 0, 2, 1, 2,
        3328, 2, 0, 2, 0, 2, 1, 2, 3327, 2, 3328, 2, 3328, 2, 0, 2,
        0, 3328, 1, 3328, 1, 3328, 2, 3328, 3328, 3328, 0, 3328, 0, 3328, 1, 3328,
        3328, 3328, 0, 3328, 0, 3328, 1, 3328, 3327, 3328, 3328, 3328, 3328, 3328, 0, 3328,
        0, 0, 1, 0, 1, 0, 2, 0, 3328, 0, 0, 0, 0, 0, 1, 0,
        3328, 0, 0, 0, 0, 0, 1, 0, 3327, 0, 3328, 0, 3328, 0, 0, 0,
        0, 0, 1, 0, 1, 0, 2, 0, 3328, 0, 0, 0, 0, 0, 1, 0,
        3328, 0, 0, 0, 0, 0, 1, 0, 3327, 0, 3328, 0, 3328, 0, 0, 0,
        0, 1, 1, 1, 1, 1, 2, 1, 3328, 1, 0, 1, 0, 1, 1, 1,
        3328, 1, 0, 1, 0, 1, 1, 1, 3327, 1, 3328, 1, 3328, 1, 0, 1
    };   // <--- Paste mảng Expected vào đây
    
    cbd_top(input_case2, hw_out);
    if(!verify(hw_out, expected_case2, "Case 2: Pattern Input")) all_pass = false;
    
    std::cout << "=============================================" << std::endl;
    if(all_pass) return 0;
    else return 1;
}